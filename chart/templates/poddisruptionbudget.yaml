{{/*
# SPDX-License-Identifier: BUSL-1.1
*/}}

{{- if and (gt (int .Values.controller.replicas) 1) .Values.controller.podDisruptionBudget.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "vso.chart.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: controller-manager
    control-plane: controller-manager
    {{- include "vso.chart.labels" . | nindent 4 }}
spec:
  {{- $rawMax := default "" .Values.controller.podDisruptionBudget.maxUnavailable -}}
  {{- $rawMin := default "" .Values.controller.podDisruptionBudget.minAvailable -}}
  {{- $max := toString $rawMax | trim -}}
  {{- $min := toString $rawMin | trim -}}

  {{- /* Presence & zero-ness checks */ -}}
  {{- $maxProvided := ne $max "" -}}
  {{- $minProvided := ne $min "" -}}
  {{- $maxZero := or (eq $max "0") (eq $max "0%") -}}
  {{- $minZero := or (eq $min "0") (eq $min "0%") -}}
  {{- $maxNonZero := and $maxProvided (not $maxZero) -}}
  {{- $minNonZero := and $minProvided (not $minZero) -}}

  {{- /* Hard stop only when both sides are non-zero (K8s forbids both keys at once) */ -}}
  {{- if and $minNonZero $maxNonZero -}}
  {{- fail "controller.podDisruptionBudget: you cannot set both maxUnavailable and minAvailable to non-zero values." -}}
  {{- end }}

  {{- /* Emit exactly one key */ -}}
  {{- if $minNonZero }}
  minAvailable:{{ if contains "%" $min }} "{{ $min }}"{{ else }} {{ $min }}{{ end }}
  {{- else if $maxNonZero }}
  maxUnavailable:{{ if contains "%" $max }} "{{ $max }}"{{ else }} {{ $max }}{{ end }}
  {{- else if and $minProvided (not $maxProvided) }}
  minAvailable:{{ if contains "%" $min }} "{{ $min }}"{{ else }} {{ $min }}{{ end }}
  {{- else if and $maxProvided (not $minProvided) }}
  maxUnavailable:{{ if contains "%" $max }} "{{ $max }}"{{ else }} {{ $max }}{{ end }}
  {{- else }}
  minAvailable: 1
  {{- end }}
  selector:
    matchLabels:
      {{- include "vso.chart.selectorLabels" . | nindent 6 }}
{{- end }}
